name: Docs
on:
  push:
    branches: [main, dev, "*-dev"]
    tags: ['v*.*.*']
    paths:
      - 'lib/docs/**'
      - '.github/workflows/docs.yml'
  pull_request:
    branches: [main, dev, "*-dev"]
    paths:
      - 'lib/docs/**'
      - '.github/workflows/docs.yml'
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
permissions:
  contents: write
defaults:
  run:
    working-directory: lib
jobs:

  preview:
    name: Preview documentation ðŸ“–
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v6
      - name: Configure Git Credentials
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com
      - name: Checkout PR branch
        run: |
          git fetch origin
          git checkout ${{ github.event.pull_request.head.ref }}
      - uses: actions/setup-python@v6
        with:
          python-version: 3.x
      - run: pip install mkdocs-material mkdocstrings 'mkdocstrings[python]' mkdocs-swagger-ui-tag mike
      - name: Build and deploy documentation
        run: mike deploy --push --allow-empty --deploy-prefix pr-preview pr-${{ github.event.number }} --message "Deploying docs preview for PR ${{ github.event.number }} ðŸ›«"

  deploy:
    name: Deploy documentation ðŸ“š
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v6
      - name: Configure Git Credentials
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com
      - name: Checkout tag
        run: |
          git fetch origin
          git checkout ${{ github.ref_name }}
      - uses: actions/setup-python@v6
        with:
          python-version: 3.x
      - run: pip install mkdocs-material mkdocstrings 'mkdocstrings[python]' mkdocs-swagger-ui-tag mike
      - name: Build and deploy documentation
        run: mike deploy --push --update-aliases --allow-empty ${{ github.ref_name }} latest --message "Deploying docs version ${{ github.ref_name }} ðŸ›«"
